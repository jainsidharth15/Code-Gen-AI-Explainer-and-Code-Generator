"""
CODE GENI â€” AI Explainer & Code Generator (Multimodal: Text + OCR)
- Preserves original two-column UI and all existing features.
- Adds OCR (pytesseract) for multimodal input (text + image).
- Integrated with Ollama local LLM via HTTP API.
"""

import streamlit as st
from datetime import datetime
import json
import textwrap
import uuid
import html
import base64
import requests
import re
import numpy as np
import cv2
import pytesseract
from PIL import Image

pytesseract.pytesseract.tesseract_cmd = r"C:\Program Files\Tesseract-OCR\tesseract.exe"


# -------------------------
# Utility functions
# -------------------------
def now_str():
    return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

def init_state():
    if "history" not in st.session_state:
        st.session_state.history = []
    if "saved_snippets" not in st.session_state:
        st.session_state.saved_snippets = {}
    if "templates" not in st.session_state:
        st.session_state.templates = DEFAULT_TEMPLATES.copy()
    if "last_prompt" not in st.session_state:
        st.session_state.last_prompt = ""
    if "ui_mode" not in st.session_state:
        st.session_state.ui_mode = "generate"
    if "show_prompt_meta" not in st.session_state:
        st.session_state.show_prompt_meta = False
    if "ollama_base_url" not in st.session_state:
        st.session_state.ollama_base_url = "http://localhost:11434"
    if "ollama_model" not in st.session_state:
        st.session_state.ollama_model = "llama3"
    if "temperature" not in st.session_state:
        st.session_state.temperature = 0.2
    if "_last_raw_response" not in st.session_state:
        st.session_state["_last_raw_response"] = ""

def save_history(entry):
    st.session_state.history.insert(0, entry)
    if len(st.session_state.history) > 120:
        st.session_state.history = st.session_state.history[:120]

def format_code_download(code, filename):
    b = code.encode("utf-8")
    b64 = base64.b64encode(b).decode()
    href = f"data:application/octet-stream;base64,{b64}"
    return href, filename

def copy_to_clipboard_button(text, key):
    escaped = html.escape(text).replace("\n", "\\n").replace("'", "\\'")
    js = f"""
    <script>
    function copyText{key}() {{
        const text = `{escaped}`;
        navigator.clipboard.writeText(text).then(()=>{{document.getElementById("copy{key}").innerText = "Copied!";}});
    }}
    </script>
    <button id="copy{key}" onclick="copyText{key}()">Copy</button>
    """
    st.components.v1.html(js, height=40)

def extract_code_and_text(text):
    m = re.search(r"```(?:\w*\n)?(.*?)```", text, re.S)
    if m:
        code = m.group(1).strip()
        explanation = (text[:m.start()] + text[m.end():]).strip()
        return code, explanation
    return "", text

def safe_rerun():
    try:
        st.rerun()
    except Exception:
        pass

def try_parse_json_from_text(raw_text):
    if raw_text is None: return None
    if isinstance(raw_text, dict): return raw_text
    try:
        return json.loads(raw_text)
    except Exception:
        pass
    start = raw_text.find('{')
    end = raw_text.rfind('}')
    if start != -1 and end != -1 and end > start:
        candidate = raw_text[start:end+1]
        try:
            return json.loads(candidate)
        except Exception:
            pass
    return None

# -------------------------
# OCR helper (Multimodal Input)
# -------------------------
def extract_text_from_image(image):
    img = np.array(image)
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    gray = cv2.threshold(gray, 150, 255, cv2.THRESH_BINARY | cv2.THRESH_OTSU)[1]
    return pytesseract.image_to_string(gray)

# -------------------------
# Templates & defaults
# -------------------------
DEFAULT_TEMPLATES = {
    "Reverse Linked List (iterative)": "Write a function to reverse a singly linked list. Input: head node. Output: new head. Time: O(n), Space: O(1).",
    "Binary Search (iterative)": "Implement binary search for a sorted integer array. Return index or -1 if not found. Provide time/space complexity.",
    "Merge Sort (recursive)": "Implement merge sort for an array of integers. Include complexity analysis and a short trace example.",
    "Dijkstra Shortest Path": "Implement Dijkstra's algorithm for shortest paths using adjacency list and priority queue. Provide complexity notes.",
}

# -------------------------
# Ollama HTTP helper
# -------------------------
def call_ollama_generate(prompt_text, model_name=None, base_url=None, temperature=0.2):
    base_url = base_url or st.session_state.ollama_base_url
    model_name = model_name or st.session_state.ollama_model
    url = base_url.rstrip("/") + "/api/generate"

    payload = {
        "model": model_name,
        "prompt": prompt_text,
        "temperature": float(temperature),
        "stream": False
    }
    resp = requests.post(url, json=payload, headers={"Content-Type": "application/json"}, timeout=300)
    if resp.status_code != 200:
        raise RuntimeError(f"Ollama API error: {resp.status_code}")
    
    data = resp.json()
    if isinstance(data, dict):
        if "response" in data: return data
        for key in ("text", "output", "_extracted_text"):
            if key in data: 
                data["_extracted_text"] = data[key]
                return data
    return data

# -------------------------
# Page config & CSS
# -------------------------
st.set_page_config(page_title="CODE GENI", page_icon="ðŸ§ ", layout="wide")

st.markdown("""
    <style>
    .header-center { text-align:center; margin-bottom:20px; }
    .bubble-user { background:#e6fffa; padding:12px; border-radius:12px; margin:8px 0; border: 1px solid #b2f2bb; }
    .bubble-assistant { background:#111827; color:white; padding:12px; border-radius:12px; margin:8px 0; }
    .timestamp { color:#94a3b8; font-size:11px; }
    .small-muted { color:#6b7280; font-size:12px; }
    </style>
    """, unsafe_allow_html=True)

init_state()

# -------------------------
# Sidebar (LEFT PANEL)
# -------------------------
with st.sidebar:
    st.markdown("### Recent history")
    if st.session_state.history:
        for i, h in enumerate(st.session_state.history[:8]):
            if st.button(f"{h.get('prompt','')[:40]}... [{h.get('timestamp','')}]", key=f"hist_{i}"):
                st.session_state.last_prompt = h.get("prompt","")
                safe_rerun()
    
    st.markdown("---")
    st.markdown("### Templates")
    for name, tpl in st.session_state.templates.items():
        if st.button(name, key=f"tpl_{name}"):
            st.session_state.last_prompt = tpl
            safe_rerun()

    st.markdown("---")
    st.markdown("### Saved snippets")
    if st.session_state.saved_snippets:
        for sid, s in list(st.session_state.saved_snippets.items())[:5]:
            if st.button(f"Load: {s['title']}", key="load_"+sid):
                st.session_state.last_prompt = s.get("prompt","")
                safe_rerun()

    st.markdown("---")
    st.markdown("### Ollama settings")
    st.text_input("Base URL", value=st.session_state.ollama_base_url, key="ollama_base_url")
    st.text_input("Model Name", value=st.session_state.ollama_model, key="ollama_model")
    st.slider("Temperature", 0.0, 1.0, value=st.session_state.temperature, key="temperature")

# -------------------------
# Main Header
# -------------------------
st.markdown('<div class="header-center"><h1>ðŸ§  CODE GENI</h1><p>AI Explainer & Code Generator (Multimodal Edition)</p></div>', unsafe_allow_html=True)

top_c1, top_c2 = st.columns([8,2])
with top_c2:
    st.button("Sign In")
    st.button("Profile")
st.markdown("---")

# -------------------------
# Two-column layout
# -------------------------
col_left, col_right = st.columns([4,6])

# LEFT COLUMN: INPUT PANEL
with col_left:
    st.markdown("### Input")
    
    # ðŸ”¹ NEW FEATURE: OCR Integration (Multimodal)
    with st.expander("ðŸ“· Multimodal Input: Extract from Image"):
        uploaded_image = st.file_uploader("Upload image (Code or Handwritten)", type=["png", "jpg", "jpeg"])
        if uploaded_image:
            img = Image.open(uploaded_image)
            st.image(img, caption="Uploaded Preview", use_container_width=True)
            if st.button("Extract Text"):
                with st.spinner("Processing OCR..."):
                    text = extract_text_from_image(img)
                    st.session_state.last_prompt = text
                    st.success("Text added to prompt area below.")
                    safe_rerun()

    prompt = st.text_area("Prompt / Code", value=st.session_state.last_prompt, height=260)
    st.session_state.last_prompt = prompt

    c1, c2 = st.columns(2)
    with c1:
        explain_line_by_line = st.checkbox("Explain line-by-line", value=True)
        include_tests = st.checkbox("Include tests", value=False)
    with c2:
        coding_style = st.selectbox("Coding style", ["Concise","Verbose","Commented"])

    b1, b2, b3 = st.columns([2,1,1])
    with b1:
        generate_clicked = st.button("Generate", type="primary", use_container_width=True)
    with b2:
        if st.button("Save snippet"):
            sid = str(uuid.uuid4())[:8]
            st.session_state.saved_snippets[sid] = {"title": f"Snippet {len(st.session_state.saved_snippets)+1}", "prompt": prompt}
            st.success("Saved!")
    with b3:
        if st.button("Clear"):
            st.session_state.last_prompt = ""
            safe_rerun()

# RIGHT COLUMN: CONVERSATION PANEL
with col_right:
    st.markdown("### Conversation")
    if st.session_state.history:
        for entry in reversed(st.session_state.history):
            ts = entry.get("timestamp","")
            if entry.get("role") == "user":
                st.markdown(f"<div class='bubble-user'><strong>You</strong> <span class='timestamp'>{ts}</span><br>{html.escape(entry.get('prompt',''))}</div>", unsafe_allow_html=True)
            else:
                st.markdown(f"<div class='bubble-assistant'><strong>CODE GENI</strong> <span class='timestamp'>{ts}</span>", unsafe_allow_html=True)
                if entry.get("code"):
                    st.code(entry["code"], language="python")
                    href, fname = format_code_download(entry["code"], f"code_{entry.get('id')}.py")
                    st.download_button("Download", entry["code"], file_name=fname, key="dl_"+entry["id"])
                    copy_to_clipboard_button(entry["code"], entry["id"])
                if entry.get("explanation"):
                    st.markdown(f"**Explanation:**\n{entry['explanation']}")
                st.markdown("</div>", unsafe_allow_html=True)
    else:
        st.info("Start by entering a prompt or uploading an image on the left.")

# -------------------------
# Generation Logic
# -------------------------
if generate_clicked and prompt.strip():
    entry_id = str(uuid.uuid4())[:8]
    save_history({"id": entry_id, "role": "user", "prompt": prompt, "timestamp": now_str()})
    
    sys_prompt = f"Return ONLY a JSON object with keys: code, explanation. Request: {prompt}"
    
    with st.spinner("Generating..."):
        try:
            raw = call_ollama_generate(sys_prompt, st.session_state.ollama_model, 
                                       st.session_state.ollama_base_url, st.session_state.temperature)
            
            text_out = raw.get("response") or raw.get("_extracted_text") or ""
            parsed = try_parse_json_from_text(text_out)
            
            if parsed and isinstance(parsed, dict):
                code = parsed.get("code", "")
                explanation = parsed.get("explanation", "")
            else:
                code, explanation = extract_code_and_text(text_out)

            save_history({"id": entry_id, "role": "assistant", "code": code, "explanation": explanation, "timestamp": now_str()})
            safe_rerun()
        except Exception as e:
            st.error(f"Ollama Error: {e}")
